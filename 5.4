library(httr)
library(jsonlite)
library(dplyr)

DMI_KEY <- "e759f4d7-3efb-421b-a164-9bc190350922"  # <- din nøgle fra portalen

api_url <- "https://dmigw.govcloud.dk/v2/metObs/collections/observation/items"

res2 <- GET(
  api_url,
  add_headers("X-Gravitee-Api-Key" = DMI_KEY),
  query = list(
    stationId = "06079",            # Anholt
    parameterId = "wind_dir",       # Wind direction
    datetime = "2023-10-20T00:00:00Z/2023-10-21T23:50:00Z")) # tidsinterval

status_code(res2) # tjekke om der adgang til api

data2 <- fromJSON(content(res2, "text"), flatten = TRUE) # lave data fra api om til tekst og "flade" det ud så det nemmere at arbejde med

anholt_df <- data2$features %>% # lave om til data frame
  mutate(
    timeStamp = data2$timeStamp,
    numberReturned = data2$numberReturned,
    type = data2$type)

ny_df <- anholt_df %>%
  mutate (properties.observed = ceiling(row_number() / 6)) %>%   # opdeler i grupper á 6 rækker
  group_by(properties.observed) %>%
  summarise(gennemsnit = mean(properties.value, na.rm = TRUE)) %>%
  ungroup()

library(ggplot2)

ggplot(ny_df, aes(x = properties.observed, y = gennemsnit)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(color = "darkblue", size = 2) +
  labs(
    title = "Gennemsnit over tid (Anholt)",
    x = "Time",
    y = "Gennemsnit af vindretning"
  ) +
  theme_minimal(base_size = 14)

res_aarhus <- GET(
  api_url,
  add_headers("X-Gravitee-Api-Key" = DMI_KEY),
  query = list(
    stationId = "06074",            # Anholt
    parameterId = "wind_dir",       # Wind direction
    datetime = "2023-10-20T00:00:00Z/2023-10-21T23:50:00Z")) # tidsinterval

status_code(res_aarhus) # tjekke om der adgang til api

data_aarhus <- fromJSON(content(res_aarhus, "text"), flatten = TRUE) # lave data fra api om til tekst og "flade" det ud så det nemmere at arbejde med

aarhus_df <- data_aarhus$features %>% # lave om til data frame
  mutate(
    timeStamp = data_aarhus$timeStamp,
    numberReturned = data_aarhus$numberReturned,
    type = data_aarhus$type)

ny_aarhus_df <- aarhus_df %>%
  mutate (properties.observed = ceiling(row_number() / 6)) %>%   # opdeler i grupper á 6 rækker
  group_by(properties.observed) %>%
  summarise(gennemsnit = mean(properties.value, na.rm = TRUE)) %>%
  ungroup()

ggplot(ny_aarhus_df, aes(x = properties.observed, y = gennemsnit)) +
  geom_line(color = "steelblue", linewidth = 1) +
  geom_point(color = "darkblue", size = 2) +
  labs(
    title = "Gennemsnit over tid (aarhus)",
    x = "Time",
    y = "Gennemsnit af vindretning"
  ) +
  theme_minimal(base_size = 14)

ggplot() +
  geom_line(data = ny_aarhus_df,
            aes(x = properties.observed, y = gennemsnit, color = "Aarhus"),
            linewidth = 1) +
  geom_line(data = ny_anholt_df,
            aes(x = properties.observed, y = gennemsnit, color = "Anholt"),
            linewidth = 1) +
  geom_point(data = ny_aarhus_df,
             aes(x = properties.observed, y = gennemsnit, color = "Aarhus"),
             size = 2) +
  geom_point(data = ny_anholt_df,
             aes(x = properties.observed, y = gennemsnit, color = "Anholt"),
             size = 2) +
  labs(
    title = "Vindretning – Aarhus vs Anholt",
    x = "Time",
    y = "Vindretning",
    color = "Station"
  ) +
  theme_minimal(base_size = 14)
